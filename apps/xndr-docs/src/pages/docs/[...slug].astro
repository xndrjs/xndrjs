---
import DocLayout from '../../layouts/DocLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import PageNavigation from '../../components/PageNavigation.astro';
import SeeAlso from '../../components/SeeAlso.astro';
import { getCollection } from 'astro:content';
import { getNavigationPages } from '../../utils/navigation';

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map((doc) => ({
    params: { slug: doc.id.replace(/\.md$/, '') },
    props: { doc },
  }));
}

interface Props {
  doc: Awaited<ReturnType<typeof getCollection>>[number];
}

const { doc } = Astro.props;
const { Content: DocContent } = await doc.render();

// Remove arrows and path prefixes from titles
const cleanTitle = (title: string): string => {
  const parts = title.split('â†’');
  return parts.length > 1 ? parts[parts.length - 1].trim() : title.trim();
};

// Generate breadcrumbs from doc path
const pathParts = doc.id.replace(/\.md$/, '').split('/');
const allDocs = await getCollection('docs');
const docIds = new Set(allDocs.map(d => d.id.replace(/\.md$/, '')));

// Helper function to check if a page exists for a given path
// A page exists only if there's a document with exactly that path
// We don't check for /overview because if overview exists, it means there are sub-pages,
// so the parent path is just a category folder, not a dedicated page
const pageExists = (path: string): boolean => {
  // Check if exact path exists as a document
  return docIds.has(path);
};

// Helper function to format label from path segment
const formatLabel = (segment: string): string => {
  return segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' ');
};

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Docs', href: '/docs/getting-started/introduction' },
];

// Build breadcrumb path incrementally for each segment
let currentPath = '';
for (let i = 0; i < pathParts.length - 1; i++) {
  const segment = pathParts[i];
  currentPath = currentPath ? `${currentPath}/${segment}` : segment;
  const segmentLabel = formatLabel(segment);
  breadcrumbItems.push({
    label: segmentLabel,
    href: `/docs/${currentPath}`,
    disabled: !pageExists(currentPath)
  });
}

// Add the current page as the last breadcrumb (always active, no link)
breadcrumbItems.push({ label: cleanTitle(doc.data.title), href: Astro.url.pathname });

// Get navigation pages (previous/next)
const currentSlug = doc.id.replace(/\.md$/, '');
const { previous, next } = await getNavigationPages(currentSlug);
---

<DocLayout title={doc.data.title} description={doc.data.description || `Documentation for ${doc.data.title}`}>
  <Breadcrumbs items={breadcrumbItems} />
  <DocContent />
  {doc.data.seeAlso && doc.data.seeAlso.length > 0 && (
    <SeeAlso links={doc.data.seeAlso} />
  )}
  <PageNavigation previous={previous} next={next} />
</DocLayout>

